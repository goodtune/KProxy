{{define "devices_content"}}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col">
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">KProxy Admin</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <a href="/admin/dashboard" class="block px-4 py-2 rounded hover:bg-gray-700">
                Dashboard
            </a>
            <a href="/admin/devices" class="block px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">
                Devices
            </a>
            <a href="/admin/profiles" class="block px-4 py-2 rounded hover:bg-gray-700">
                Profiles
            </a>
            <a href="/admin/rules" class="block px-4 py-2 rounded hover:bg-gray-700">
                Rules
            </a>
            <a href="/admin/logs" class="block px-4 py-2 rounded hover:bg-gray-700">
                Logs
            </a>
            <a href="/admin/sessions" class="block px-4 py-2 rounded hover:bg-gray-700">
                Sessions
            </a>
        </nav>

        <div class="p-4 border-t border-gray-700">
            <button id="logoutBtn" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white">
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Device Management</h2>
                <button id="newDeviceBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                    + New Device
                </button>
            </div>

            <!-- Devices Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Name
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Identifiers
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Profile
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="devicesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- New/Edit Device Modal -->
<div id="deviceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 id="modalTitle" class="text-lg font-medium text-gray-900 mb-4">New Device</h3>
            <form id="deviceForm">
                <input type="hidden" id="deviceId">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Device Name</label>
                    <input type="text" id="deviceName" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="deviceDescription" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Identifiers (one per line)</label>
                    <textarea id="deviceIdentifiers" required rows="4" placeholder="192.168.1.100&#10;aa:bb:cc:dd:ee:ff&#10;10.0.0.0/24"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Enter IP addresses, MAC addresses, or CIDR ranges</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Profile</label>
                    <select id="deviceProfile" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Profile...</option>
                        <!-- Populated by JavaScript -->
                    </select>
                </div>

                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="deviceActive" checked class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Active</span>
                    </label>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/admin/login';
    } catch (error) {
        console.error('Logout failed:', error);
    }
});

// Load devices and profiles on page load
let devices = [];
let profiles = [];

async function loadProfiles() {
    try {
        const response = await fetch('/api/profiles');
        const data = await response.json();
        profiles = data.profiles || [];

        // Populate profile select
        const select = document.getElementById('deviceProfile');
        select.innerHTML = '<option value="">Select Profile...</option>';
        profiles.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            option.textContent = profile.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load profiles:', error);
    }
}

async function loadDevices() {
    try {
        const response = await fetch('/api/devices');
        const data = await response.json();
        devices = data.devices || [];
        renderDevices();
    } catch (error) {
        console.error('Failed to load devices:', error);
        document.getElementById('devicesTableBody').innerHTML =
            '<tr><td colspan="5" class="px-6 py-4 text-center text-red-600">Failed to load devices</td></tr>';
    }
}

function renderDevices() {
    const tbody = document.getElementById('devicesTableBody');

    if (devices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No devices found</td></tr>';
        return;
    }

    tbody.innerHTML = devices.map(device => {
        const profile = profiles.find(p => p.id === device.profile_id);
        const identifiers = device.identifiers ? device.identifiers.slice(0, 3).join(', ') +
            (device.identifiers.length > 3 ? '...' : '') : 'None';

        return `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${escapeHtml(device.name)}</div>
                    ${device.description ? `<div class="text-sm text-gray-500">${escapeHtml(device.description)}</div>` : ''}
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 font-mono">${escapeHtml(identifiers)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${profile ? escapeHtml(profile.name) : '<span class="text-gray-400">None</span>'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${device.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                        ${device.active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="editDevice('${device.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                    <button onclick="deleteDevice('${device.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal management
const modal = document.getElementById('deviceModal');
const newDeviceBtn = document.getElementById('newDeviceBtn');
const cancelBtn = document.getElementById('cancelBtn');
const deviceForm = document.getElementById('deviceForm');

newDeviceBtn.addEventListener('click', () => {
    document.getElementById('modalTitle').textContent = 'New Device';
    deviceForm.reset();
    document.getElementById('deviceId').value = '';
    document.getElementById('deviceActive').checked = true;
    modal.classList.remove('hidden');
});

cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
});

// Edit device
window.editDevice = async (id) => {
    const device = devices.find(d => d.id === id);
    if (!device) return;

    document.getElementById('modalTitle').textContent = 'Edit Device';
    document.getElementById('deviceId').value = device.id;
    document.getElementById('deviceName').value = device.name;
    document.getElementById('deviceDescription').value = device.description || '';
    document.getElementById('deviceIdentifiers').value = device.identifiers ? device.identifiers.join('\n') : '';
    document.getElementById('deviceProfile').value = device.profile_id || '';
    document.getElementById('deviceActive').checked = device.active;
    modal.classList.remove('hidden');
};

// Delete device
window.deleteDevice = async (id) => {
    if (!confirm('Are you sure you want to delete this device?')) return;

    try {
        const response = await fetch(`/api/devices/${id}`, { method: 'DELETE' });
        if (response.ok) {
            await loadDevices();
        } else {
            alert('Failed to delete device');
        }
    } catch (error) {
        console.error('Delete failed:', error);
        alert('Failed to delete device');
    }
};

// Form submission
deviceForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const deviceId = document.getElementById('deviceId').value;
    const identifiers = document.getElementById('deviceIdentifiers').value
        .split('\n')
        .map(s => s.trim())
        .filter(s => s.length > 0);

    const deviceData = {
        name: document.getElementById('deviceName').value,
        description: document.getElementById('deviceDescription').value,
        identifiers: identifiers,
        profile_id: document.getElementById('deviceProfile').value || null,
        active: document.getElementById('deviceActive').checked
    };

    try {
        const url = deviceId ? `/api/devices/${deviceId}` : '/api/devices';
        const method = deviceId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(deviceData)
        });

        if (response.ok) {
            modal.classList.add('hidden');
            await loadDevices();
        } else {
            const error = await response.json();
            alert('Failed to save device: ' + (error.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Save failed:', error);
        alert('Failed to save device');
    }
});

// Initial load
loadProfiles().then(() => loadDevices());
</script>
{{end}}
