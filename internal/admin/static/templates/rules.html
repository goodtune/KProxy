{{define "rules_content"}}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col">
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">KProxy Admin</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <a href="/admin/dashboard" class="block px-4 py-2 rounded hover:bg-gray-700">
                Dashboard
            </a>
            <a href="/admin/devices" class="block px-4 py-2 rounded hover:bg-gray-700">
                Devices
            </a>
            <a href="/admin/profiles" class="block px-4 py-2 rounded hover:bg-gray-700">
                Profiles
            </a>
            <a href="/admin/rules" class="block px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">
                Rules
            </a>
            <a href="/admin/logs" class="block px-4 py-2 rounded hover:bg-gray-700">
                Logs
            </a>
            <a href="/admin/sessions" class="block px-4 py-2 rounded hover:bg-gray-700">
                Sessions
            </a>
        </nav>

        <div class="p-4 border-t border-gray-700">
            <button id="logoutBtn" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white">
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Rules Management</h2>
            </div>

            <!-- Tabs for different rule types -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button class="rule-tab-btn border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600" data-tab="rules">
                            Domain Rules
                        </button>
                        <button class="rule-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="bypass">
                            Bypass Rules
                        </button>
                        <button class="rule-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="time">
                            Time Rules
                        </button>
                        <button class="rule-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="usage">
                            Usage Limits
                        </button>
                    </nav>
                </div>

                <!-- Domain Rules Tab -->
                <div id="rulesTabContent" class="rule-tab-content p-6">
                    <div class="mb-6 flex gap-4 items-center">
                        <div class="flex-1">
                            <input type="text" id="searchDomain" placeholder="Search by domain..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <select id="filterProfile" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Profiles</option>
                        </select>
                        <select id="filterAction" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Actions</option>
                            <option value="allow">Allow</option>
                            <option value="block">Block</option>
                        </select>
                        <button id="newRuleBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded whitespace-nowrap">
                            + New Rule
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Profile</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Priority</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Domain</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Path</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rulesTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bypass Rules Tab -->
                <div id="bypassTabContent" class="rule-tab-content p-6 hidden">
                    <div class="mb-6 flex gap-4 items-center">
                        <div class="flex-1">
                            <p class="text-sm text-gray-600">Bypass rules allow domains to skip proxy interception entirely (DNS-level bypass)</p>
                        </div>
                        <button id="newBypassRuleBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded whitespace-nowrap">
                            + New Bypass Rule
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Domain Pattern</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bypassRulesTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Time Rules Tab -->
                <div id="timeTabContent" class="rule-tab-content p-6 hidden">
                    <div class="mb-6 flex gap-4 items-center">
                        <div class="flex-1">
                            <p class="text-sm text-gray-600">Time rules restrict access based on time of day and day of week</p>
                        </div>
                        <select id="filterTimeProfile" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Profiles</option>
                        </select>
                    </div>

                    <div id="timeRulesContainer" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">Loading...</div>
                    </div>
                </div>

                <!-- Usage Limits Tab -->
                <div id="usageTabContent" class="rule-tab-content p-6 hidden">
                    <div class="mb-6 flex gap-4 items-center">
                        <div class="flex-1">
                            <p class="text-sm text-gray-600">Usage limits restrict daily access time for categories or specific domains</p>
                        </div>
                        <select id="filterUsageProfile" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Profiles</option>
                        </select>
                    </div>

                    <div id="usageLimitsContainer" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Rule Modal -->
<div id="ruleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ruleModalTitle" class="text-lg font-medium text-gray-900">New Rule</h3>
                <button id="closeRuleModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="ruleForm">
                <input type="hidden" id="ruleId">
                <input type="hidden" id="ruleProfileId">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Profile</label>
                    <select id="ruleProfile" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select profile...</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Domain <span class="text-red-500">*</span></label>
                    <input type="text" id="ruleDomain" required placeholder="example.com or *.example.com"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-xs text-gray-500">Supports wildcards: *.example.com or .example.com</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Path (optional)</label>
                    <input type="text" id="rulePath" placeholder="/path/to/resource"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                    <select id="ruleAction" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="allow">Allow</option>
                        <option value="block">Block</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category (optional)</label>
                    <input type="text" id="ruleCategory" placeholder="social, gaming, etc."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <input type="number" id="rulePriority" value="100"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-xs text-gray-500">Higher priority rules are evaluated first</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelRuleBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                        Save Rule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bypass Rule Modal -->
<div id="bypassRuleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">New Bypass Rule</h3>
                <button id="closeBypassModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="bypassRuleForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Domain Pattern <span class="text-red-500">*</span></label>
                    <input type="text" id="bypassDomain" required placeholder="*.example.com"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-xs text-gray-500">Domain will bypass proxy interception at DNS level</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (optional)</label>
                    <textarea id="bypassDescription" rows="2" placeholder="Reason for bypass..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelBypassBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                        Save Bypass Rule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/admin/login';
    } catch (error) {
        console.error('Logout failed:', error);
    }
});

// Tab management
const tabBtns = document.querySelectorAll('.rule-tab-btn');
const tabContents = document.querySelectorAll('.rule-tab-content');

tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        // Update tab buttons
        tabBtns.forEach(b => {
            b.classList.remove('border-blue-500', 'text-blue-600');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        btn.classList.remove('border-transparent', 'text-gray-500');
        btn.classList.add('border-blue-500', 'text-blue-600');

        // Update tab content
        tabContents.forEach(content => content.classList.add('hidden'));
        document.getElementById(tabName + 'TabContent').classList.remove('hidden');

        // Load data for the selected tab
        if (tabName === 'rules') loadAllRules();
        else if (tabName === 'bypass') loadBypassRules();
        else if (tabName === 'time') loadAllTimeRules();
        else if (tabName === 'usage') loadAllUsageLimits();
    });
});

// Data storage
let profiles = [];
let allRules = [];
let bypassRules = [];
let allTimeRules = [];
let allUsageLimits = [];

// Load profiles for filters
async function loadProfiles() {
    try {
        const response = await fetch('/api/profiles');
        const data = await response.json();
        profiles = data.profiles || [];

        // Populate profile selectors
        const selectors = ['filterProfile', 'filterTimeProfile', 'filterUsageProfile', 'ruleProfile'];
        selectors.forEach(id => {
            const select = document.getElementById(id);
            if (id === 'ruleProfile') {
                select.innerHTML = '<option value="">Select profile...</option>';
            } else {
                select.innerHTML = '<option value="">All Profiles</option>';
            }
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name;
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Failed to load profiles:', error);
    }
}

// Load all rules from all profiles
async function loadAllRules() {
    try {
        allRules = [];
        for (const profile of profiles) {
            const response = await fetch(`/api/profiles/${profile.id}/rules`);
            const data = await response.json();
            const rules = data.rules || [];
            rules.forEach(rule => {
                rule.profileName = profile.name;
                allRules.push(rule);
            });
        }
        renderRules();
    } catch (error) {
        console.error('Failed to load rules:', error);
        document.getElementById('rulesTableBody').innerHTML =
            '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Failed to load rules</td></tr>';
    }
}

function renderRules() {
    const tbody = document.getElementById('rulesTableBody');
    const searchTerm = document.getElementById('searchDomain').value.toLowerCase();
    const profileFilter = document.getElementById('filterProfile').value;
    const actionFilter = document.getElementById('filterAction').value;

    let filtered = allRules.filter(rule => {
        const matchesSearch = !searchTerm || rule.domain.toLowerCase().includes(searchTerm);
        const matchesProfile = !profileFilter || rule.profile_id === profileFilter;
        const matchesAction = !actionFilter || rule.action === actionFilter;
        return matchesSearch && matchesProfile && matchesAction;
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No rules found</td></tr>';
        return;
    }

    // Sort by priority descending
    filtered.sort((a, b) => b.priority - a.priority);

    tbody.innerHTML = filtered.map(rule => `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800">${escapeHtml(rule.profileName)}</span>
            </td>
            <td class="px-4 py-3 text-sm">${rule.priority}</td>
            <td class="px-4 py-3 text-sm font-mono text-blue-600">${escapeHtml(rule.domain)}</td>
            <td class="px-4 py-3 text-sm font-mono">${rule.path || '-'}</td>
            <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 text-xs rounded ${rule.action === 'allow' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${rule.action}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">${rule.category || '-'}</td>
            <td class="px-4 py-3 text-sm">
                <button onclick="editRule('${rule.profile_id}', '${rule.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                <button onclick="deleteRule('${rule.profile_id}', '${rule.id}')" class="text-red-600 hover:text-red-900">Delete</button>
            </td>
        </tr>
    `).join('');
}

// Load bypass rules
async function loadBypassRules() {
    try {
        const response = await fetch('/api/bypass-rules');
        const data = await response.json();
        bypassRules = data.bypass_rules || [];
        renderBypassRules();
    } catch (error) {
        console.error('Failed to load bypass rules:', error);
        document.getElementById('bypassRulesTableBody').innerHTML =
            '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">Failed to load bypass rules</td></tr>';
    }
}

function renderBypassRules() {
    const tbody = document.getElementById('bypassRulesTableBody');

    if (bypassRules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">No bypass rules defined</td></tr>';
        return;
    }

    tbody.innerHTML = bypassRules.map(rule => `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-mono text-blue-600">${escapeHtml(rule.domain)}</td>
            <td class="px-4 py-3 text-sm">${rule.description || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${new Date(rule.created_at).toLocaleDateString()}</td>
            <td class="px-4 py-3 text-sm">
                <button onclick="deleteBypassRule('${rule.id}')" class="text-red-600 hover:text-red-900">Delete</button>
            </td>
        </tr>
    `).join('');
}

// Load all time rules
async function loadAllTimeRules() {
    try {
        allTimeRules = [];
        for (const profile of profiles) {
            const response = await fetch(`/api/profiles/${profile.id}/time-rules`);
            const data = await response.json();
            const rules = data.time_rules || [];
            rules.forEach(rule => {
                rule.profileName = profile.name;
                rule.profileId = profile.id;
                allTimeRules.push(rule);
            });
        }
        renderTimeRules();
    } catch (error) {
        console.error('Failed to load time rules:', error);
    }
}

function renderTimeRules() {
    const container = document.getElementById('timeRulesContainer');
    const profileFilter = document.getElementById('filterTimeProfile').value;

    let filtered = allTimeRules.filter(rule => !profileFilter || rule.profileId === profileFilter);

    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">No time rules defined</div>';
        return;
    }

    container.innerHTML = filtered.map(rule => `
        <div class="bg-gray-50 p-4 rounded border border-gray-200">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="text-sm font-medium mb-2">
                        <span class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-800">${escapeHtml(rule.profileName)}</span>
                    </div>
                    <div class="text-sm mb-1"><strong>Days:</strong> ${(rule.days_of_week || []).join(', ') || 'All days'}</div>
                    <div class="text-sm mb-1"><strong>Time:</strong> ${rule.start_time || '00:00'} - ${rule.end_time || '23:59'}</div>
                    <div class="text-sm"><strong>Action:</strong> <span class="font-medium ${rule.action === 'allow' ? 'text-green-600' : 'text-red-600'}">${rule.action}</span></div>
                </div>
                <button onclick="deleteTimeRule('${rule.profileId}', '${rule.id}')" class="text-red-600 hover:text-red-900 text-sm">Delete</button>
            </div>
        </div>
    `).join('');
}

// Load all usage limits
async function loadAllUsageLimits() {
    try {
        allUsageLimits = [];
        for (const profile of profiles) {
            const response = await fetch(`/api/profiles/${profile.id}/usage-limits`);
            const data = await response.json();
            const limits = data.usage_limits || [];
            limits.forEach(limit => {
                limit.profileName = profile.name;
                limit.profileId = profile.id;
                allUsageLimits.push(limit);
            });
        }
        renderUsageLimits();
    } catch (error) {
        console.error('Failed to load usage limits:', error);
    }
}

function renderUsageLimits() {
    const container = document.getElementById('usageLimitsContainer');
    const profileFilter = document.getElementById('filterUsageProfile').value;

    let filtered = allUsageLimits.filter(limit => !profileFilter || limit.profileId === profileFilter);

    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">No usage limits defined</div>';
        return;
    }

    container.innerHTML = filtered.map(limit => `
        <div class="bg-gray-50 p-4 rounded border border-gray-200">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="text-sm font-medium mb-2">
                        <span class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-800">${escapeHtml(limit.profileName)}</span>
                    </div>
                    <div class="text-sm mb-1"><strong>Category:</strong> ${limit.category || 'Specific domains'}</div>
                    ${limit.domains ? `<div class="text-sm mb-1 font-mono text-gray-600">${limit.domains.join(', ')}</div>` : ''}
                    <div class="text-sm mb-1"><strong>Limit:</strong> ${Math.floor(limit.daily_minutes / 60)}h ${limit.daily_minutes % 60}m per day</div>
                    ${limit.inject_timer ? '<div class="text-xs text-blue-600">Timer injection enabled</div>' : ''}
                </div>
                <button onclick="deleteUsageLimit('${limit.profileId}', '${limit.id}')" class="text-red-600 hover:text-red-900 text-sm">Delete</button>
            </div>
        </div>
    `).join('');
}

// Modal management
const ruleModal = document.getElementById('ruleModal');
const bypassModal = document.getElementById('bypassRuleModal');

document.getElementById('newRuleBtn').addEventListener('click', () => {
    document.getElementById('ruleModalTitle').textContent = 'New Rule';
    document.getElementById('ruleForm').reset();
    document.getElementById('ruleId').value = '';
    document.getElementById('ruleProfileId').value = '';
    ruleModal.classList.remove('hidden');
});

document.getElementById('newBypassRuleBtn').addEventListener('click', () => {
    document.getElementById('bypassRuleForm').reset();
    bypassModal.classList.remove('hidden');
});

document.getElementById('closeRuleModalBtn').addEventListener('click', () => {
    ruleModal.classList.add('hidden');
});

document.getElementById('closeBypassModalBtn').addEventListener('click', () => {
    bypassModal.classList.add('hidden');
});

document.getElementById('cancelRuleBtn').addEventListener('click', () => {
    ruleModal.classList.add('hidden');
});

document.getElementById('cancelBypassBtn').addEventListener('click', () => {
    bypassModal.classList.add('hidden');
});

// Edit rule
window.editRule = async (profileId, ruleId) => {
    const rule = allRules.find(r => r.profile_id === profileId && r.id === ruleId);
    if (!rule) return;

    document.getElementById('ruleModalTitle').textContent = 'Edit Rule';
    document.getElementById('ruleId').value = rule.id;
    document.getElementById('ruleProfileId').value = rule.profile_id;
    document.getElementById('ruleProfile').value = rule.profile_id;
    document.getElementById('ruleDomain').value = rule.domain;
    document.getElementById('rulePath').value = rule.path || '';
    document.getElementById('ruleAction').value = rule.action;
    document.getElementById('ruleCategory').value = rule.category || '';
    document.getElementById('rulePriority').value = rule.priority;

    ruleModal.classList.remove('hidden');
};

// Delete handlers
window.deleteRule = async (profileId, ruleId) => {
    if (!confirm('Delete this rule?')) return;

    try {
        const response = await fetch(`/api/profiles/${profileId}/rules/${ruleId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadAllRules();
        } else {
            alert('Failed to delete rule');
        }
    } catch (error) {
        console.error('Failed to delete rule:', error);
        alert('Failed to delete rule');
    }
};

window.deleteBypassRule = async (ruleId) => {
    if (!confirm('Delete this bypass rule?')) return;

    try {
        const response = await fetch(`/api/bypass-rules/${ruleId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadBypassRules();
        } else {
            alert('Failed to delete bypass rule');
        }
    } catch (error) {
        console.error('Failed to delete bypass rule:', error);
        alert('Failed to delete bypass rule');
    }
};

window.deleteTimeRule = async (profileId, ruleId) => {
    if (!confirm('Delete this time rule?')) return;

    try {
        const response = await fetch(`/api/profiles/${profileId}/time-rules/${ruleId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadAllTimeRules();
        } else {
            alert('Failed to delete time rule');
        }
    } catch (error) {
        console.error('Failed to delete time rule:', error);
        alert('Failed to delete time rule');
    }
};

window.deleteUsageLimit = async (profileId, limitId) => {
    if (!confirm('Delete this usage limit?')) return;

    try {
        const response = await fetch(`/api/profiles/${profileId}/usage-limits/${limitId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadAllUsageLimits();
        } else {
            alert('Failed to delete usage limit');
        }
    } catch (error) {
        console.error('Failed to delete usage limit:', error);
        alert('Failed to delete usage limit');
    }
};

// Form submissions
document.getElementById('ruleForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const ruleId = document.getElementById('ruleId').value;
    const profileId = document.getElementById('ruleProfileId').value || document.getElementById('ruleProfile').value;

    if (!profileId) {
        alert('Please select a profile');
        return;
    }

    const ruleData = {
        domain: document.getElementById('ruleDomain').value,
        path: document.getElementById('rulePath').value || undefined,
        action: document.getElementById('ruleAction').value,
        category: document.getElementById('ruleCategory').value || undefined,
        priority: parseInt(document.getElementById('rulePriority').value)
    };

    try {
        const url = ruleId ? `/api/profiles/${profileId}/rules/${ruleId}` : `/api/profiles/${profileId}/rules`;
        const method = ruleId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ruleData)
        });

        if (response.ok) {
            ruleModal.classList.add('hidden');
            await loadAllRules();
        } else {
            const error = await response.json();
            alert('Failed to save rule: ' + (error.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Save failed:', error);
        alert('Failed to save rule');
    }
});

document.getElementById('bypassRuleForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const ruleData = {
        domain: document.getElementById('bypassDomain').value,
        description: document.getElementById('bypassDescription').value || undefined
    };

    try {
        const response = await fetch('/api/bypass-rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ruleData)
        });

        if (response.ok) {
            bypassModal.classList.add('hidden');
            await loadBypassRules();
        } else {
            const error = await response.json();
            alert('Failed to save bypass rule: ' + (error.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Save failed:', error);
        alert('Failed to save bypass rule');
    }
});

// Filter handlers
document.getElementById('searchDomain').addEventListener('input', renderRules);
document.getElementById('filterProfile').addEventListener('change', renderRules);
document.getElementById('filterAction').addEventListener('change', renderRules);
document.getElementById('filterTimeProfile').addEventListener('change', renderTimeRules);
document.getElementById('filterUsageProfile').addEventListener('change', renderUsageLimits);

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initial load
(async () => {
    await loadProfiles();
    await loadAllRules();
})();
</script>
{{end}}
