{{define "profiles_content"}}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col">
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">KProxy Admin</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <a href="/admin/dashboard" class="block px-4 py-2 rounded hover:bg-gray-700">
                Dashboard
            </a>
            <a href="/admin/devices" class="block px-4 py-2 rounded hover:bg-gray-700">
                Devices
            </a>
            <a href="/admin/profiles" class="block px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">
                Profiles
            </a>
            <a href="/admin/rules" class="block px-4 py-2 rounded hover:bg-gray-700">
                Rules
            </a>
            <a href="/admin/logs" class="block px-4 py-2 rounded hover:bg-gray-700">
                Logs
            </a>
            <a href="/admin/sessions" class="block px-4 py-2 rounded hover:bg-gray-700">
                Sessions
            </a>
        </nav>

        <div class="p-4 border-t border-gray-700">
            <button id="logoutBtn" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white">
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Profile Management</h2>
                <button id="newProfileBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                    + New Profile
                </button>
            </div>

            <!-- Profiles List -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="profilesGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </main>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white mb-10">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900">Profile Details</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-8">
                    <button class="tab-btn border-b-2 border-blue-500 py-2 px-1 text-sm font-medium text-blue-600" data-tab="settings">
                        Settings
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="rules">
                        Rules
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="time-rules">
                        Time Rules
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="usage-limits">
                        Usage Limits
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tabContent">
                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <form id="profileForm">
                        <input type="hidden" id="profileId">

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Profile Name</label>
                            <input type="text" id="profileName" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="profileDescription" rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="profileDefaultAllow" class="mr-2">
                                <span class="text-sm font-medium text-gray-700">Default Allow (allow all domains not explicitly blocked)</span>
                            </label>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                                Save Profile
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Rules Tab -->
                <div id="rulesTab" class="tab-content hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <p class="text-sm text-gray-600">Domain and path-based access rules</p>
                        <button id="newRuleBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                            + New Rule
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Priority</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Domain</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Path</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rulesTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Time Rules Tab -->
                <div id="timeRulesTab" class="tab-content hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <p class="text-sm text-gray-600">Time-of-day and day-of-week access restrictions</p>
                        <button id="newTimeRuleBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                            + New Time Rule
                        </button>
                    </div>

                    <div id="timeRulesTableBody" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Usage Limits Tab -->
                <div id="usageLimitsTab" class="tab-content hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <p class="text-sm text-gray-600">Daily time limits for categories or specific domains</p>
                        <button id="newUsageLimitBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                            + New Usage Limit
                        </button>
                    </div>

                    <div id="usageLimitsTableBody" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/admin/login';
    } catch (error) {
        console.error('Logout failed:', error);
    }
});

// Tab management
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');

tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        // Update tab buttons
        tabBtns.forEach(b => {
            b.classList.remove('border-blue-500', 'text-blue-600');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        btn.classList.remove('border-transparent', 'text-gray-500');
        btn.classList.add('border-blue-500', 'text-blue-600');

        // Update tab content
        tabContents.forEach(content => content.classList.add('hidden'));
        document.getElementById(tabName + 'Tab').classList.remove('hidden');
    });
});

// Load profiles
let profiles = [];
let currentProfile = null;

async function loadProfiles() {
    try {
        const response = await fetch('/api/profiles');
        const data = await response.json();
        profiles = data.profiles || [];
        renderProfiles();
    } catch (error) {
        console.error('Failed to load profiles:', error);
    }
}

function renderProfiles() {
    const grid = document.getElementById('profilesGrid');

    if (profiles.length === 0) {
        grid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8">No profiles found</div>';
        return;
    }

    grid.innerHTML = profiles.map(profile => `
        <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition cursor-pointer" onclick="openProfile('${profile.id}')">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">${escapeHtml(profile.name)}</h3>
            ${profile.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(profile.description)}</p>` : ''}
            <div class="flex items-center justify-between">
                <span class="text-xs ${profile.default_allow ? 'text-green-600' : 'text-red-600'}">
                    ${profile.default_allow ? 'Default: Allow' : 'Default: Block'}
                </span>
                <button onclick="deleteProfile(event, '${profile.id}')" class="text-red-600 hover:text-red-800 text-sm">
                    Delete
                </button>
            </div>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal management
const modal = document.getElementById('profileModal');
const newProfileBtn = document.getElementById('newProfileBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

newProfileBtn.addEventListener('click', () => {
    currentProfile = null;
    document.getElementById('modalTitle').textContent = 'New Profile';
    document.getElementById('profileForm').reset();
    document.getElementById('profileId').value = '';

    // Hide rule tabs for new profile
    document.querySelectorAll('[data-tab]').forEach((btn, idx) => {
        if (idx === 0) {
            btn.classList.remove('hidden');
        } else {
            btn.classList.add('hidden');
        }
    });

    // Show settings tab
    tabContents.forEach(content => content.classList.add('hidden'));
    document.getElementById('settingsTab').classList.remove('hidden');

    modal.classList.remove('hidden');
});

closeModalBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
});

window.openProfile = async (id) => {
    const profile = profiles.find(p => p.id === id);
    if (!profile) return;

    currentProfile = profile;
    document.getElementById('modalTitle').textContent = `Edit Profile: ${profile.name}`;
    document.getElementById('profileId').value = profile.id;
    document.getElementById('profileName').value = profile.name;
    document.getElementById('profileDescription').value = profile.description || '';
    document.getElementById('profileDefaultAllow').checked = profile.default_allow;

    // Show all tabs for existing profile
    document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.classList.remove('hidden');
    });

    // Load rules, time rules, and usage limits
    await Promise.all([
        loadRules(profile.id),
        loadTimeRules(profile.id),
        loadUsageLimits(profile.id)
    ]);

    modal.classList.remove('hidden');
};

window.deleteProfile = async (event, id) => {
    event.stopPropagation();
    if (!confirm('Are you sure you want to delete this profile?')) return;

    try {
        const response = await fetch(`/api/profiles/${id}`, { method: 'DELETE' });
        if (response.ok) {
            await loadProfiles();
        } else {
            alert('Failed to delete profile');
        }
    } catch (error) {
        console.error('Delete failed:', error);
        alert('Failed to delete profile');
    }
};

// Profile form submission
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const profileId = document.getElementById('profileId').value;
    const profileData = {
        name: document.getElementById('profileName').value,
        description: document.getElementById('profileDescription').value,
        default_allow: document.getElementById('profileDefaultAllow').checked
    };

    try {
        const url = profileId ? `/api/profiles/${profileId}` : '/api/profiles';
        const method = profileId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profileData)
        });

        if (response.ok) {
            await loadProfiles();
            if (!profileId) {
                modal.classList.add('hidden');
            }
        } else {
            const error = await response.json();
            alert('Failed to save profile: ' + (error.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Save failed:', error);
        alert('Failed to save profile');
    }
});

// Rules management
async function loadRules(profileId) {
    try {
        const response = await fetch(`/api/profiles/${profileId}/rules`);
        const data = await response.json();
        const rules = data.rules || [];
        renderRules(rules);
    } catch (error) {
        console.error('Failed to load rules:', error);
    }
}

function renderRules(rules) {
    const tbody = document.getElementById('rulesTableBody');

    if (rules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No rules defined</td></tr>';
        return;
    }

    // Sort by priority descending
    rules.sort((a, b) => b.priority - a.priority);

    tbody.innerHTML = rules.map(rule => `
        <tr>
            <td class="px-3 py-2 text-sm">${rule.priority}</td>
            <td class="px-3 py-2 text-sm font-mono">${escapeHtml(rule.domain)}</td>
            <td class="px-3 py-2 text-sm font-mono">${rule.path || '-'}</td>
            <td class="px-3 py-2 text-sm">
                <span class="px-2 py-1 text-xs rounded ${rule.action === 'allow' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${rule.action}
                </span>
            </td>
            <td class="px-3 py-2 text-sm">${rule.category || '-'}</td>
            <td class="px-3 py-2 text-sm">
                <button onclick="deleteRule('${rule.id}')" class="text-red-600 hover:text-red-900">Delete</button>
            </td>
        </tr>
    `).join('');
}

window.deleteRule = async (ruleId) => {
    if (!currentProfile || !confirm('Delete this rule?')) return;

    try {
        const response = await fetch(`/api/profiles/${currentProfile.id}/rules/${ruleId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadRules(currentProfile.id);
        }
    } catch (error) {
        console.error('Failed to delete rule:', error);
    }
};

// Time rules management
async function loadTimeRules(profileId) {
    try {
        const response = await fetch(`/api/profiles/${profileId}/time-rules`);
        const data = await response.json();
        const timeRules = data.time_rules || [];
        renderTimeRules(timeRules);
    } catch (error) {
        console.error('Failed to load time rules:', error);
    }
}

function renderTimeRules(timeRules) {
    const container = document.getElementById('timeRulesTableBody');

    if (timeRules.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">No time rules defined</div>';
        return;
    }

    container.innerHTML = timeRules.map(rule => `
        <div class="bg-gray-50 p-4 rounded">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="text-sm font-medium mb-1">Days: ${(rule.days_of_week || []).join(', ') || 'All days'}</div>
                    <div class="text-sm text-gray-600">Time: ${rule.start_time || '00:00'} - ${rule.end_time || '23:59'}</div>
                    <div class="text-sm text-gray-600 mt-1">Action: <span class="font-medium">${rule.action}</span></div>
                </div>
                <button onclick="deleteTimeRule('${rule.id}')" class="text-red-600 hover:text-red-900 text-sm">Delete</button>
            </div>
        </div>
    `).join('');
}

window.deleteTimeRule = async (ruleId) => {
    if (!currentProfile || !confirm('Delete this time rule?')) return;

    try {
        const response = await fetch(`/api/profiles/${currentProfile.id}/time-rules/${ruleId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadTimeRules(currentProfile.id);
        }
    } catch (error) {
        console.error('Failed to delete time rule:', error);
    }
};

// Usage limits management
async function loadUsageLimits(profileId) {
    try {
        const response = await fetch(`/api/profiles/${profileId}/usage-limits`);
        const data = await response.json();
        const limits = data.usage_limits || [];
        renderUsageLimits(limits);
    } catch (error) {
        console.error('Failed to load usage limits:', error);
    }
}

function renderUsageLimits(limits) {
    const container = document.getElementById('usageLimitsTableBody');

    if (limits.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">No usage limits defined</div>';
        return;
    }

    container.innerHTML = limits.map(limit => `
        <div class="bg-gray-50 p-4 rounded">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="text-sm font-medium mb-1">${limit.category || 'Specific domains'}</div>
                    ${limit.domains ? `<div class="text-sm text-gray-600 font-mono">${limit.domains.join(', ')}</div>` : ''}
                    <div class="text-sm text-gray-600 mt-1">Limit: ${Math.floor(limit.daily_minutes / 60)}h ${limit.daily_minutes % 60}m per day</div>
                    ${limit.inject_timer ? '<div class="text-xs text-blue-600 mt-1">Timer injection enabled</div>' : ''}
                </div>
                <button onclick="deleteUsageLimit('${limit.id}')" class="text-red-600 hover:text-red-900 text-sm">Delete</button>
            </div>
        </div>
    `).join('');
}

window.deleteUsageLimit = async (limitId) => {
    if (!currentProfile || !confirm('Delete this usage limit?')) return;

    try {
        const response = await fetch(`/api/profiles/${currentProfile.id}/usage-limits/${limitId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadUsageLimits(currentProfile.id);
        }
    } catch (error) {
        console.error('Failed to delete usage limit:', error);
    }
};

// Initial load
loadProfiles();
</script>
{{end}}
