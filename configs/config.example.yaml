# KProxy Configuration Example

server:
  # DNS server (primary entry point for clients)
  dns_port: 53
  dns_enable_udp: true
  dns_enable_tcp: true

  # Proxy ports
  http_port: 80
  https_port: 443

  # Admin interface
  admin_port: 8443
  admin_domain: "kproxy.home.local"

  # Metrics
  metrics_port: 9090

  # Bind address (0.0.0.0 for all interfaces)
  bind_address: "0.0.0.0"

dns:
  # Upstream DNS servers for bypass/forwarded queries
  upstream_servers:
    - "8.8.8.8:53"
    - "1.1.1.1:53"

  # TTL settings
  intercept_ttl: 60       # TTL for intercepted domains (low for quick config changes)
  bypass_ttl_cap: 300     # Max TTL for bypassed domains (0 = no cap, use upstream)
  block_ttl: 60           # TTL for blocked domains

  # Query timeout
  upstream_timeout: "5s"

  # Global bypass domains (always bypass, never intercept)
  global_bypass:
    - "ocsp.*.com"        # Certificate validation
    - "crl.*.com"
    - "*.ocsp.*"
    - "time.*.com"        # NTP-related
    - "time.*.gov"

dhcp:
  # Enable/disable DHCP server for netboot support
  enabled: false

  # DHCP server port and bind address
  port: 67
  bind_address: "0.0.0.0"

  # DHCP server settings (auto-detected if not specified)
  # server_ip: "192.168.1.1"       # DHCP server identifier (auto-detected from network interface)
  # subnet_mask: "255.255.255.0"   # Network subnet mask (auto-detected from network interface)
  # gateway: "192.168.1.1"         # Default gateway for clients (auto-detected, uses server IP)

  # DNS servers to advertise to clients (empty = use server_ip as DNS)
  dns_servers: []

  # IP address pool for dynamic allocation (REQUIRED - must be configured manually)
  range_start: "192.168.1.100"
  range_end: "192.168.1.200"

  # Lease duration
  lease_time: "24h"

  # PXE/Network boot settings (for diskless/kiosk systems)
  # For BIOS PXE boot (legacy):
  boot_filename: "pxelinux.0"               # TFTP boot file
  boot_server_name: "kproxy.home.local"     # Boot server hostname
  tftp_ip: "192.168.1.1"                    # TFTP server IP

  # For UEFI HTTP boot (modern, recommended):
  boot_uri: "http://boot.netboot.xyz/ipxe/netboot.xyz.efi"  # HTTP boot URI
  # Examples:
  #   - netboot.xyz: "http://boot.netboot.xyz/ipxe/netboot.xyz.efi"
  #   - Custom iPXE: "http://192.168.1.1:8080/boot/ipxe.efi"
  #   - Local image: "http://192.168.1.1:8080/boot/kiosk.iso"

tls:
  # CA certificate and key paths
  ca_cert: "/etc/kproxy/ca/root-ca.crt"
  ca_key: "/etc/kproxy/ca/root-ca.key"

  # Intermediate CA (for signing)
  intermediate_cert: "/etc/kproxy/ca/intermediate-ca.crt"
  intermediate_key: "/etc/kproxy/ca/intermediate-ca.key"

  # Certificate cache settings
  cert_cache_size: 1000
  cert_cache_ttl: "24h"
  cert_validity: "24h"

storage:
  # Storage backend type (only Redis is supported)
  type: "redis"

  # Redis settings
  redis:
    host: "localhost"
    port: 6379
    password: ""
    db: 0

    # Connection pool
    pool_size: 10
    min_idle_conns: 5

    # Timeouts
    dial_timeout: "5s"
    read_timeout: "3s"
    write_timeout: "3s"

logging:
  level: "info"  # debug, info, warn, error
  format: "json" # json, text
  request_log_retention_days: 30

policy:
  # Default action for unknown devices
  default_action: "block"  # or "allow"

  # Default action for devices without matching rules
  default_allow: false

  # Device identification
  use_mac_address: true
  arp_cache_ttl: "5m"

usage_tracking:
  # Inactivity threshold for session tracking
  inactivity_timeout: "2m"

  # Minimum session duration to count
  min_session_duration: "10s"

  # Daily reset time (local timezone)
  daily_reset_time: "00:00"

response_modification:
  # Enable/disable timer injection
  enabled: true

  # Sites where injection is disabled
  disabled_hosts:
    - "*.bank.com"
    - "secure.*"

  # Content types to modify
  allowed_content_types:
    - "text/html"

admin:
  # Enable/disable admin interface
  enabled: true

  # Admin interface port and bind address
  port: 8443
  bind_address: "0.0.0.0"

  # Initial admin credentials (change on first login!)
  initial_username: "admin"
  initial_password: "changeme"

  # JWT secret for session tokens (CHANGE THIS!)
  jwt_secret: "change-this-to-a-random-secret-key"

  # Session settings
  session_timeout: "24h"

  # Rate limiting
  rate_limit: 100  # requests per window
  rate_limit_window: "1m"
